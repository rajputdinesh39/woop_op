<?xml version="1.0"?>
<config>
    <modules>
        <Eway_Rapid31>
            <version>1.5.3</version>
        </Eway_Rapid31>
    </modules>
    <global>
        <models>
            <ewayrapid>
                <class>Eway_Rapid31_Model</class>
                <resourceModel>ewayrapid_resource</resourceModel>
            </ewayrapid>
            <ewayrapid_resource>
                <class>Eway_Rapid31_Model_Resource</class>
            </ewayrapid_resource>
        </models>

        <blocks>
            <ewayrapid>
                <class>Eway_Rapid31_Block</class>
            </ewayrapid>
            <adminhtml>
                <rewrite>
                    <sales_order_grid>Eway_Rapid31_Block_Sales_Order_Grid</sales_order_grid>
                    <page_head>Eway_Rapid31_Block_Html_Head</page_head>
                </rewrite>
            </adminhtml>
        </blocks>

        <helpers>
            <ewayrapid>
                <class>Eway_Rapid31_Helper</class>
            </ewayrapid>
        </helpers>
        <resources>
            <ewayrapid_setup>
                <setup>
                    <module>Eway_Rapid31</module>
                    <class>Eway_Rapid31_Model_Resource_Setup</class>
                </setup>
            </ewayrapid_setup>
        </resources>
        <payment>
            <cc>
                <types>
                    <DC>
                        <code>DC</code>
                        <name>Diners Club International</name>
                        <order>100</order>
                    </DC>
                    <VE>
                        <code>VE</code>
                        <name>Visa Electron</name>
                        <order>11</order>
                    </VE>
                    <ME>
                        <code>ME</code>
                        <name>Maestro</name>
                        <order>21</order>
                    </ME>
                </types>
            </cc>
        </payment>
        <fieldsets>
            <sales_convert_quote_payment>
                <fraud_action>
                    <to_order_payment>*</to_order_payment>
                </fraud_action>
                <fraud_codes>
                    <to_order_payment>*</to_order_payment>
                </fraud_codes>
                <transaction_captured>
                    <to_order_payment>*</to_order_payment>
                </transaction_captured>
                <beagle_score>
                    <to_order_payment>*</to_order_payment>
                </beagle_score>
                <beagle_verification>
                    <to_order_payment>*</to_order_payment>
                </beagle_verification>
            </sales_convert_quote_payment>
            <sales_convert_order_payment>
                <fraud_action>
                    <to_quote_payment>*</to_quote_payment>
                </fraud_action>
                <fraud_codes>
                    <to_order_payment>*</to_order_payment>
                </fraud_codes>
                <transaction_captured>
                    <to_order_payment>*</to_order_payment>
                </transaction_captured>
                <beagle_score>
                    <to_order_payment>*</to_order_payment>
                </beagle_score>
                <beagle_verification>
                    <to_order_payment>*</to_order_payment>
                </beagle_verification>
            </sales_convert_order_payment>
        </fieldsets>
    </global>
    <frontend>
        <secure_url>
            <eway_account_cards>/ewayrapid/mycards</eway_account_cards>
            <eway_checkout_redirect>/ewayrapid/transparent</eway_checkout_redirect>
            <eway_checkout_shared>/ewayrapid/sharedpage</eway_checkout_shared>
        </secure_url>
        <translate>
            <modules>
                <Eway_Rapid31>
                    <files>
                        <default>Eway_Rapid31.csv</default>
                    </files>
                </Eway_Rapid31>
            </modules>
        </translate>
        <layout>
            <updates>
                <ewayrapid>
                    <file>ewayrapid/layout.xml</file>
                </ewayrapid>
            </updates>
        </layout>
        <routers>
            <ewayrapid>
                <use>standard</use>
                <args>
                    <module>Eway_Rapid31</module>
                    <frontName>ewayrapid</frontName>
                </args>
            </ewayrapid>
        </routers>

        <events>

            <controller_action_predispatch_ewayrapid_mycards_index>
                <observers>
                    <eway_rapid31_my_cards>
                        <type>singleton</type>
                        <class>ewayrapid/observer</class>
                        <method>myCards</method>
                    </eway_rapid31_my_cards>
                </observers>
            </controller_action_predispatch_ewayrapid_mycards_index>

            <!-- Event default -->
            <controller_action_predispatch_checkout_onepage_index>
                <observers>
                    <eway_rapid31_check_customer_mark>
                        <type>singleton</type>
                        <class>ewayrapid/observer</class>
                        <method>checkCustomerMark</method>
                    </eway_rapid31_check_customer_mark>
                </observers>
            </controller_action_predispatch_checkout_onepage_index>

            <sales_order_place_before>
                <observers>
                    <sales_order_place_before>
                        <class>ewayrapid/observer</class>
                        <method>sales_order_place_before</method>
                    </sales_order_place_before>
                </observers>
            </sales_order_place_before>

            <sales_order_place_after>
                <observers>
                    <sales_order_place_after>
                        <class>ewayrapid/observer</class>
                        <method>sales_order_place_after</method>
                    </sales_order_place_after>
                </observers>
            </sales_order_place_after>

            <sales_order_invoice_save_after>
                <observers>
                    <sales_order_invoice_save_after>
                        <class>ewayrapid/observer</class>
                        <method>sales_order_invoice_save_after</method>
                    </sales_order_invoice_save_after>
                </observers>
            </sales_order_invoice_save_after>
            <checkout_type_onepage_save_order_after>
                <observers>
                    <checkout_type_onepage_save_order_after>
                        <class>ewayrapid/observer</class>
                        <method>checkout_type_onepage_save_order_after</method>
                    </checkout_type_onepage_save_order_after>
                </observers>
            </checkout_type_onepage_save_order_after>

            <!--<sales_order_save_commit_before>
                <observers>
                    <sales_order_save_commit_before>
                        <class>ewayrapid/observer</class>
                        <method>sales_order_save_commit_before</method>
                    </sales_order_save_commit_before>
                </observers>
            </sales_order_save_commit_before>

            <sales_order_save_commit_after>
                <observers>
                    <sales_order_save_commit_after>
                        <class>ewayrapid/observer</class>
                        <method>sales_order_save_commit_after</method>
                    </sales_order_save_commit_after>
                </observers>
            </sales_order_save_commit_after>-->

            <checkout_submit_all_after>
                <observers>
                    <checkout_submit_all_after>
                        <class>ewayrapid/observer</class>
                        <method>checkout_submit_all_after</method>
                    </checkout_submit_all_after>
                </observers>
                <observers>
                    <eway_recurring_profile>
                        <class>ewayrapid/observer</class>
                        <method>createRecurringOrder</method>
                    </eway_recurring_profile>
                </observers>
            </checkout_submit_all_after>
        </events>

    </frontend>
    
    <!--
    <admin>
        <routers>
            <ewayrapid_admin>
                <use>admin</use>
                <args>
                    <module>Eway_Rapid31_Adminhtml</module>
                    <frontName>ewayadmin</frontName>
                </args>
            </ewayrapid_admin>
        </routers>
    </admin>
    -->
    
    <admin>
        <routers>
            <adminhtml>
                <args>
                    <modules>
                        <eway_rapid31_adminhtml after="Mage_Adminhtml">Eway_Rapid31_Adminhtml</eway_rapid31_adminhtml>
                        <eway_rapid31 before="-">Eway_Rapid31_Adminhtml</eway_rapid31>
                    </modules>
                </args>
            </adminhtml>
        </routers>
    </admin>
    
    <adminhtml>
        <translate>
            <modules>
                <Eway_Rapid31>
                    <files>
                        <default>Eway_Rapid31.csv</default>
                    </files>
                </Eway_Rapid31>
            </modules>
        </translate>
        <layout>
            <updates>
                <ewayrapid>
                    <file>ewayrapid/layout.xml</file>
                </ewayrapid>
            </updates>
        </layout>
        <!--<menu>
            <system>
                <children>
                    <eway_admin_index>
                        <title>Eway Mass</title>
                        <action>ewayadmin/index/index</action>
                    </eway_admin_index>
                    <eway_admin_mass_authorised>
                        <title>Eway Mass</title>
                        <action>ewayadmin/index/massEwayAuthorised</action>
                    </eway_admin_mass_authorised>
                    <eway_admin_mass_pending>
                        <title>Eway Mass</title>
                        <action>ewayadmin/index/massPending</action>
                    </eway_admin_mass_pending>
                </children>
            </system>
        </menu>-->
        <menu>
            <sales>
                <children>
                    <eway_orders>
                        <title>eWAY</title>
                        <action>adminhtml/ewayadmin/ewayorders</action>
                        <sort_order>100</sort_order>
                    </eway_orders>
                </children>
            </sales>
        </menu>
    </adminhtml>
    <default>
        <payment>
            <ewayrapid_general>
                <active>0</active>
                <mode>sandbox</mode>
                <sandbox_endpoint>https://api.sandbox.ewaypayments.com/</sandbox_endpoint>
                <live_endpoint>https://api.ewaypayments.com/</live_endpoint>
                <payment_action>authorize_capture</payment_action>
                <connection_type>direct</connection_type>
                <mask_value>1</mask_value>
                <auto_complete>0</auto_complete>
                <can_edit_token>1</can_edit_token>
                <can_cancel_subscriptions>0</can_cancel_subscriptions>
                <block_fraud_customers>1</block_fraud_customers>
                <useccv>1</useccv>
                <cctypes>VI,MC</cctypes>
                <order_status>eway_captured</order_status>
                <allowspecific>0</allowspecific>
                <ssl_verification>0</ssl_verification>
                <transfer_cart_items>1</transfer_cart_items>
                <debug>0</debug>
                <billing_agreement_title>eWAY Billing Agreement</billing_agreement_title>
            </ewayrapid_general>
            <ewayrapid_notsaved>
                <model>ewayrapid/method_notsaved</model>
                <active>0</active>
                <title>Credit Card - eWAY (not saved)</title>
            </ewayrapid_notsaved>
            <ewayrapid_saved>
                <model>ewayrapid/method_saved</model>
                <active>0</active>
                <title>Credit Card - eWAY (saved)</title>
            </ewayrapid_saved>
            <ewayrapid_ewayone>
                <model>ewayrapid/method_ewayone</model>
                <active>0</active>
                <title>Credit Card - eWAY</title>
                <save_card>1</save_card>
                <save_text>Save my details</save_text>
                <save_card_checked>1</save_card_checked>
            </ewayrapid_ewayone>
        </payment>
    </default>
    <phpunit>
        <suite>
            <modules>
                <Eway_Rapid31/>
            </modules>
        </suite>
    </phpunit>
    <crontab>
        <jobs>
            <eway_recurring_order>
                <schedule>
                    <cron_expr>0 * * * *</cron_expr>
                </schedule>
                <run>
                    <model>ewayrapid/observer::cronRecurringOrder</model>
                </run>
            </eway_recurring_order>
            <eway_rapid31>
                <schedule>
                    <cron_expr>0 */3 * * *</cron_expr>
                </schedule>
                <run>
                    <model>ewayrapid/ewayCron::querySuspectFraud</model>
                </run>
            </eway_rapid31>
        </jobs>
    </crontab>
</config>